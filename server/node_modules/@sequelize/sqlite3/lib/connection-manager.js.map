{
  "version": 3,
  "sources": ["../src/connection-manager.ts"],
  "sourcesContent": ["import type { AbstractConnection, ConnectionOptions } from '@sequelize/core';\nimport { AbstractConnectionManager, ConnectionError } from '@sequelize/core';\nimport { logger } from '@sequelize/core/_non-semver-use-at-your-own-risk_/utils/logger.js';\nimport { checkFileExists } from '@sequelize/utils/node';\nimport fs from 'node:fs/promises';\nimport path from 'node:path';\nimport * as Sqlite3 from 'sqlite3';\nimport type { SqliteDialect } from './dialect.js';\n\nconst debug = logger.debugContext('connection:sqlite3');\n\nexport type Sqlite3Module = typeof Sqlite3;\n\nconst CLOSED_SYMBOL = Symbol('closed');\n\nexport interface SqliteConnection extends AbstractConnection, Sqlite3.Database {\n  // Not declared by sqlite3's typings\n  filename: string;\n\n  // Sequelize extension\n  [CLOSED_SYMBOL]?: boolean;\n}\n\nexport interface SqliteConnectionOptions {\n  /**\n   * Path to the SQLite database file\n   *\n   * Special values:\n   * - ':memory:': to use a temporary in-memory database.\n   * - '': to create a temporary disk-based database.\n   *\n   * Note: temporary databases require the pool to have the following configuration:\n   * - max size: 1\n   * - idle timeout: Infinity\n   * - max uses per resource: Infinity\n   *\n   * @default 'sequelize.sqlite' in your current working directory\n   */\n  storage?: string;\n\n  /**\n   * The mode to open the database connection with.\n   *\n   * An integer flag that can be a combination of the following values:\n   * - OPEN_CREATE\n   * - OPEN_READONLY\n   * - OPEN_READWRITE\n   * - OPEN_SHAREDCACHE\n   * - OPEN_PRIVATECACHE\n   * - OPEN_FULLMUTEX\n   * - OPEN_URI\n   *\n   * This package exports each of these values\n   *\n   * @example\n   * ```ts\n   * import { SqliteDialect, OPEN_CREATE, OPEN_READWRITE } from '@sequelize/sqlite3';\n   *\n   * new Sequelize({\n   *   dialect: SqliteDialect,\n   *   storage: 'db.sqlite',\n   *   mode: OPEN_CREATE | OPEN_READWRITE,\n   * });\n   * ```\n   */\n  mode?: number;\n\n  /**\n   * The \"PRAGMA KEY\" password to use for the connection.\n   */\n  password?: string;\n}\n\nexport {\n  OPEN_CREATE,\n  OPEN_FULLMUTEX,\n  OPEN_PRIVATECACHE,\n  OPEN_READONLY,\n  OPEN_READWRITE,\n  OPEN_SHAREDCACHE,\n  OPEN_URI,\n} from 'sqlite3';\n\nexport class SqliteConnectionManager extends AbstractConnectionManager<\n  SqliteDialect,\n  SqliteConnection\n> {\n  readonly #lib: Sqlite3Module;\n\n  constructor(dialect: SqliteDialect) {\n    super(dialect);\n\n    this.#lib = this.dialect.options.sqlite3Module ?? Sqlite3;\n  }\n\n  async connect(options: ConnectionOptions<SqliteDialect>): Promise<SqliteConnection> {\n    // Using ?? instead of || is important because an empty string signals to SQLite to create a temporary disk-based database.\n    const storage = options.storage ?? path.join(process.cwd(), 'sequelize.sqlite');\n    const inMemory = storage === ':memory:';\n\n    const isTemporaryStorage = inMemory || storage === '';\n    if (isTemporaryStorage) {\n      const pool = this.sequelize.pool;\n      const writePool = pool.write;\n\n      // @ts-expect-error -- PR sequelize-pool to expose `idleTimeoutMillis`\n      if (writePool.idleTimeoutMillis !== Infinity) {\n        throw new Error(`SQLite is configured to use a temporary database, but the pool is configured to close idle connections, which would lead to data loss while the application is running.\nTo fix this, set the pool's idleTimeoutMillis to Infinity, or use a non-temporary database.`);\n      }\n\n      // @ts-expect-error -- PR sequelize-pool to expose `maxUsesPerResource`\n      if (writePool.maxUsesPerResource !== Infinity) {\n        // @ts-expect-error -- PR sequelize-pool to expose `maxUsesPerResource`\n        throw new Error(`SQLite is configured to use a temporary database, but the pool is configured to close connections after ${writePool.maxUsesPerResources}, which would lead to data loss while the application is running.\nTo fix this, set the pool's maxUsesPerResource to Infinity, or use a non-temporary database.`);\n      }\n\n      if (writePool.maxSize !== 1) {\n        throw new Error(`SQLite is configured to use a temporary database, but the pool is configured to allow more than one connection, which would create separate temporary databases.\nTo fix this, set the pool's maxSize to 1, or use a non-temporary database.`);\n      }\n\n      if (pool.read) {\n        throw new Error(`SQLite is configured to use a temporary database, but read-replication is enabled, which would read a different temporary database.\nTo fix this, disable read replication, or use a non-temporary database.`);\n      }\n    }\n\n    const defaultReadWriteMode = this.#lib.OPEN_READWRITE | this.#lib.OPEN_CREATE;\n    const readWriteMode = options.mode ?? defaultReadWriteMode;\n\n    const storageDir = path.dirname(storage);\n\n    if (\n      !isTemporaryStorage &&\n      (readWriteMode & this.#lib.OPEN_CREATE) !== 0 &&\n      !(await checkFileExists(storageDir))\n    ) {\n      // automatic path provision for `options.storage`\n      await fs.mkdir(storageDir, { recursive: true });\n    }\n\n    const connection = await new Promise<SqliteConnection>((resolve, reject) => {\n      const connectionInstance = new this.#lib.Database(\n        storage,\n        readWriteMode,\n        (err: Error | null) => {\n          if (err) {\n            return void reject(new ConnectionError(err));\n          }\n\n          debug(`sqlite connection acquired`);\n\n          resolve(connectionInstance);\n        },\n      ) as SqliteConnection;\n    });\n\n    if (options.password) {\n      // Make it possible to define and use password for sqlite encryption plugin like sqlcipher\n      connection.run(`PRAGMA KEY=${this.sequelize.escape(options.password)}`);\n    }\n\n    if (this.dialect.options.foreignKeys !== false) {\n      // Make it possible to define and use foreign key constraints unless\n      // explicitly disallowed. It's still opt-in per relation\n      connection.run('PRAGMA FOREIGN_KEYS=ON');\n    }\n\n    return connection;\n  }\n\n  validate(connection: SqliteConnection): boolean {\n    return !connection[CLOSED_SYMBOL];\n  }\n\n  async disconnect(connection: SqliteConnection): Promise<void> {\n    if (connection[CLOSED_SYMBOL]) {\n      return;\n    }\n\n    return new Promise((resolve, reject) => {\n      connection.close(err => {\n        if (err) {\n          return reject(err);\n        }\n\n        debug(`sqlite connection released`);\n\n        connection[CLOSED_SYMBOL] = true;\n\n        resolve();\n      });\n    });\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,kBAA2D;AAC3D,oBAAuB;AACvB,kBAAgC;AAChC,sBAAe;AACf,uBAAiB;AACjB,cAAyB;AAmEzB,qBAQO;AAxEP,MAAM,QAAQ,qBAAO,aAAa,oBAAoB;AAItD,MAAM,gBAAgB,OAAO,QAAQ;AAsE9B,MAAM,gCAAgC,sCAG3C;AAAA,EACS;AAAA,EAET,YAAY,SAAwB;AAClC,UAAM,OAAO;AAEb,SAAK,OAAO,KAAK,QAAQ,QAAQ,iBAAiB;AAAA,EACpD;AAAA,EAEA,MAAM,QAAQ,SAAsE;AAElF,UAAM,UAAU,QAAQ,WAAW,iBAAAA,QAAK,KAAK,QAAQ,IAAI,GAAG,kBAAkB;AAC9E,UAAM,WAAW,YAAY;AAE7B,UAAM,qBAAqB,YAAY,YAAY;AACnD,QAAI,oBAAoB;AACtB,YAAM,OAAO,KAAK,UAAU;AAC5B,YAAM,YAAY,KAAK;AAGvB,UAAI,UAAU,sBAAsB,UAAU;AAC5C,cAAM,IAAI,MAAM;AAAA,4FACoE;AAAA,MACtF;AAGA,UAAI,UAAU,uBAAuB,UAAU;AAE7C,cAAM,IAAI,MAAM,2GAA2G,UAAU,mBAAmB;AAAA,6FACnE;AAAA,MACvF;AAEA,UAAI,UAAU,YAAY,GAAG;AAC3B,cAAM,IAAI,MAAM;AAAA,2EACmD;AAAA,MACrE;AAEA,UAAI,KAAK,MAAM;AACb,cAAM,IAAI,MAAM;AAAA,wEACgD;AAAA,MAClE;AAAA,IACF;AAEA,UAAM,uBAAuB,KAAK,KAAK,iBAAiB,KAAK,KAAK;AAClE,UAAM,gBAAgB,QAAQ,QAAQ;AAEtC,UAAM,aAAa,iBAAAA,QAAK,QAAQ,OAAO;AAEvC,QACE,CAAC,uBACA,gBAAgB,KAAK,KAAK,iBAAiB,KAC5C,CAAE,UAAM,6BAAgB,UAAU,GAClC;AAEA,YAAM,gBAAAC,QAAG,MAAM,YAAY,EAAE,WAAW,KAAK,CAAC;AAAA,IAChD;AAEA,UAAM,aAAa,MAAM,IAAI,QAA0B,CAAC,SAAS,WAAW;AAC1E,YAAM,qBAAqB,IAAI,KAAK,KAAK;AAAA,QACvC;AAAA,QACA;AAAA,QACA,CAAC,QAAsB;AACrB,cAAI,KAAK;AACP,mBAAO,KAAK,OAAO,IAAI,4BAAgB,GAAG,CAAC;AAAA,UAC7C;AAEA,gBAAM,4BAA4B;AAElC,kBAAQ,kBAAkB;AAAA,QAC5B;AAAA,MACF;AAAA,IACF,CAAC;AAED,QAAI,QAAQ,UAAU;AAEpB,iBAAW,IAAI,cAAc,KAAK,UAAU,OAAO,QAAQ,QAAQ,CAAC,EAAE;AAAA,IACxE;AAEA,QAAI,KAAK,QAAQ,QAAQ,gBAAgB,OAAO;AAG9C,iBAAW,IAAI,wBAAwB;AAAA,IACzC;AAEA,WAAO;AAAA,EACT;AAAA,EAEA,SAAS,YAAuC;AAC9C,WAAO,CAAC,WAAW,aAAa;AAAA,EAClC;AAAA,EAEA,MAAM,WAAW,YAA6C;AAC5D,QAAI,WAAW,aAAa,GAAG;AAC7B;AAAA,IACF;AAEA,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,iBAAW,MAAM,SAAO;AACtB,YAAI,KAAK;AACP,iBAAO,OAAO,GAAG;AAAA,QACnB;AAEA,cAAM,4BAA4B;AAElC,mBAAW,aAAa,IAAI;AAE5B,gBAAQ;AAAA,MACV,CAAC;AAAA,IACH,CAAC;AAAA,EACH;AACF;",
  "names": ["path", "fs"]
}
